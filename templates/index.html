<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
            }
          }
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style for the chart's drop shadow, which works better than box-shadow for irregular shapes */
        .chart-shadow {
            filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.07));
        }
        .dark .chart-shadow {
            filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.25));
        }
        /* Spinner for loading state */
        .loader {
            border: 2px solid #f3f3f3; /* Light grey */
            border-top: 2px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased min-h-screen">

<!-- App Header -->
<header class="bg-white/75 dark:bg-slate-900/75 backdrop-blur-lg border-b border-slate-200 dark:border-slate-700 h-16 sticky top-0 z-40 flex items-center justify-between px-4 sm:px-6 lg:px-8">
    <h1 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">File Analyzer</h1>
    <div class="flex items-center gap-2">
        <button id="help-button" class="icon-button h-9 w-9 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors" title="Help" aria-label="Open help guide">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
        </button>
        <button id="burger-menu" class="icon-button h-9 w-9 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors" title="Open Settings" aria-label="Open Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.4l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        </button>
        <button id="sidebar-tab" class="icon-button h-9 w-9 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors" title="Toggle Group List" aria-label="Toggle Group List">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></svg>
        </button>
    </div>
</header>

<!-- Toast Message Container -->
<div id="toast-container" class="fixed top-20 right-4 z-[100] w-full max-w-xs space-y-3"></div>

<!-- Left Settings Sidebar -->
<aside id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-slate-800 shadow-xl z-50 transform transition-transform ease-in-out duration-300 -translate-x-full">
    <div class="p-6 pt-20">
        <h3 class="text-lg font-semibold mb-4">Settings</h3>
        <ul class="space-y-4">
            <li class="flex items-center justify-between">
                <span class="font-medium">Dark Mode</span>
                <label for="theme-toggle-switch" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="theme-toggle-switch" class="sr-only peer">
                    <div class="w-11 h-6 bg-slate-200 dark:bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-indigo-600"></div>
                </label>
            </li>
            <li class="flex items-center justify-between">
                <span class="font-medium">Language</span>
                <div class="w-1/2">
                    <select id="language-select" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="en">English</option>
                        <option value="es">Español</option>
                        <option value="fr">Français</option>
                        <!-- Add more languages in the future -->
                    </select>
                </div>
            </li>
        </ul>
    </div>
</aside>

<!-- Right Groups Sidebar -->
<aside id="right-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-800 shadow-xl z-50 transform transition-transform ease-in-out duration-300 translate-x-full">
    <div class="p-6 pt-20">
        <h3 class="text-lg font-semibold mb-4">Groups</h3>
        <div class="space-y-3">
        {% if not groups %}
            <p class="text-sm text-center text-slate-500 dark:text-slate-400 mt-8">Your processed file groups will appear here.</p>
        {% endif %}
        {% for group_id, results in groups.items() %}
        <div class="sidebar-item relative group bg-slate-100 dark:bg-slate-700/50 p-4 rounded-lg cursor-pointer transition-all hover:ring-2 hover:ring-indigo-500" id="sidebar-tab-{{ group_id }}" data-group-id="{{ group_id }}" title="Click to view. Right-click to rename." role="button" tabindex="0">
            <div>
                <span class="font-semibold text-slate-800 dark:text-slate-100 sidebar-item-name">{{ results.display_name }}</span>
                <small class="block text-xs text-slate-500 dark:text-slate-400 truncate sidebar-item-filename">{{ results.filename }}</small>
            </div>
            <button class="delete-group-btn absolute top-2 right-2 h-7 w-7 rounded-full flex items-center justify-center bg-slate-200 dark:bg-slate-600 text-slate-500 dark:text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500 hover:text-white" data-group-id="{{ group_id }}" title="Delete Group">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
            </button>
        </div>
        {% endfor %}
        </div>
    </div>
</aside>

<!-- Main Content -->
<main class="main-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
    
    <!-- Upload Card -->
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-slate-200 dark:border-slate-700" id="upload-card">
        <div class="p-6 text-center">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Upload & Analyze</h2>
            <p class="mt-2 text-slate-600 dark:text-slate-400">Upload a CSV, TXT, or Excel file to begin.</p>
        </div>
        <form method="post" enctype="multipart/form-data" class="p-6 border-t border-slate-200 dark:border-slate-700 space-y-6">
            <label for="file-upload" class="file-drop-area flex flex-col items-center justify-center w-full h-48 border-2 border-slate-300 dark:border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <div id="file-label-text" class="flex flex-col items-center justify-center pt-5 pb-6 text-slate-500 dark:text-slate-400">
                    <svg class="w-8 h-8 mb-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                    <p class="mb-2 text-sm"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                    <p class="text-xs">CSV, XLSX, XLS, or TXT</p>
                </div>
            </label>
            <input id="file-upload" type="file" name="file" accept=".csv,.xlsx,.xls,.txt" class="hidden" required>
            
            <div class="w-full max-w-sm mx-auto">
                <label for="group-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Assign to Group</label>
                <select name="group_id" id="group-select" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    <option value="group_1">Group 1</option> <option value="group_2">Group 2</option> <option value="group_3">Group 3</option> <option value="group_4">Group 4</option> <option value="group_5">Group 5</option>
                </select>
            </div>

            <div class="text-center">
                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-slate-900 bg-indigo-600 text-white hover:bg-indigo-700 h-10 py-2 px-6">Analyze</button>
            </div>
        </form>
    </section>

    <!-- Results Cards -->
    {% for group_id, results in groups.items() %}
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 transition-all duration-300" id="results-card-{{ group_id }}" data-group-id="{{ group_id }}">
        <div class="p-6 border-b border-slate-200 dark:border-slate-700">
             <h2 id="results-title-{{ group_id }}" class="text-2xl font-bold text-center text-slate-900 dark:text-white mb-6">{{ results.display_name }}: Analysis & Preview</h2>
             <!-- Progress Tracker -->
             <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 text-center sm:text-left">Processing Pipeline</h3>
             <ol class="flex items-center w-full text-sm font-medium text-center text-slate-500 dark:text-slate-400">
                <li class="flex md:w-full items-center text-green-600 dark:text-green-400 sm:after:content-[''] after:w-full after:h-1 after:border-b after:border-green-200 dark:after:border-green-700 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10">
                    <span class="flex items-center"><svg class="w-4 h-4 mr-2 sm:w-5 sm:h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg> Upload</span>
                </li>
                <li class="flex md:w-full items-center text-green-600 dark:text-green-400 sm:after:content-[''] after:w-full after:h-1 after:border-b after:border-green-200 dark:after:border-green-700 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10">
                    <span class="flex items-center"><svg class="w-4 h-4 mr-2 sm:w-5 sm:h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg> Process</span>
                </li>
                <li class="flex md:w-full items-center text-green-600 dark:text-green-400 sm:after:content-[''] after:w-full after:h-1 after:border-b after:border-green-200 dark:after:border-green-700 after:border-1 after:hidden sm:after:inline-block after:mx-6 xl:after:mx-10">
                    <span class="flex items-center"><svg class="w-4 h-4 mr-2 sm:w-5 sm:h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg> Preview</span>
                </li>
                <li class="flex items-center text-indigo-600 dark:text-indigo-400">
                    <span class="flex items-center"><span class="mr-2 h-5 w-5 rounded-full border-2 border-current flex items-center justify-center font-bold text-xs">4</span> Export</span>
                </li>
            </ol>
        </div>
        <div class="p-6 space-y-8">
            <!-- Stats Grid -->
            <div id="stats-grid-{{ group_id }}" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                {% for label, value, key in [('File Name', results.filename, 'filename'), ('File Size', results.filesize_kb~' KB', 'filesize'), ('Encoding', results.encoding, 'encoding'), ('Rows', results.rows, 'rows'), ('Columns', results.columns, 'columns'), ('Missing Cells', results.missing_values, 'missing_values'), ('Duplicate Rows', results.duplicate_rows, 'duplicate_rows')] %}
                <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <dt class="text-sm font-medium text-slate-500 dark:text-slate-400 truncate">{{ label }}</dt>
                    <dd class="mt-1 text-xl font-semibold text-slate-900 dark:text-white truncate" title="{{ value }}" data-stat-key="{{ key }}">{{ value }}</dd>
                </div>
                {% endfor %}
            </div>

            <!-- Charts -->
            {% if results.quality_stats %}
            <div id="chart-container-{{ group_id }}" data-stats='{{ results.quality_stats | tojson | safe }}' class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-8 border-t border-slate-200 dark:border-slate-700">
                <div class="text-center">
                    <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Row Quality</h3>
                    <div class="relative h-48 w-full"><canvas id="rows-chart-{{ group_id }}" class="chart-shadow"></canvas></div>
                </div>
                <div class="text-center">
                    <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Cell Quality</h3>
                    <div class="relative h-48 w-full"><canvas id="cells-chart-{{ group_id }}" class="chart-shadow"></canvas></div>
                </div>
            </div>
            {% endif %}

            <!-- Processing Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-8 border-t border-slate-200 dark:border-slate-700">
                <div>
                    <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">Applied Transformations</h3>
                    <ul class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    {% for transform in results.transformations %}
                        <li class="flex items-start"><span class="text-indigo-500 mt-1 mr-2">✓</span><span>{{ transform }}</span></li>
                    {% else %} <li>No automatic transformations applied.</li> {% endfor %}
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">Detected Column Types</h3>
                    <div class="space-y-1 text-sm text-slate-600 dark:text-slate-300 max-h-48 overflow-y-auto pr-2">
                    {% for col, dtype in results.column_types.items() %}
                        <div class="flex justify-between items-baseline"><strong class="font-medium text-slate-700 dark:text-slate-200 truncate pr-2">{{ col }}</strong> <span class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-full px-2 py-0.5">{{ dtype }}</span></div>
                    {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Export & Preview -->
            <div class="pt-8 border-t border-slate-200 dark:border-slate-700">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                    <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Data Preview</h3>
                    <div class="flex items-center gap-3">
                        <a href="/export/{{ group_id }}/csv" class="export-button inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-slate-900 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 h-9 px-4 py-2" download>Export CSV</a>
                        <a href="/export/{{ group_id }}/xlsx" class="export-button inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-slate-900 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 h-9 px-4 py-2" download>Export XLSX</a>
                    </div>
                </div>
                <div id="preview-container-{{ group_id }}">
                    <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                        <table class="min-w-full table-auto">
                            <thead class="bg-slate-100 dark:bg-slate-800">
                                <tr>
                                    {% for col in results.preview.columns %}
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
                                        {{ col }}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                {% for row in results.preview.data %}
                                <tr class="bg-white dark:bg-slate-900 even:bg-slate-50 dark:even:bg-slate-800/50">
                                    {% for cell in row %}
                                        <td class="px-6 py-4 whitespace-nowrap align-top text-sm text-slate-700 dark:text-slate-300 font-mono">{{ cell }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- NEW: Filters Section -->
            <div class="pt-8 border-t border-slate-200 dark:border-slate-700">
                <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-4">Data Cleaning Filters</h3>
                <div id="filter-list-{{ group_id }}" class="space-y-4 mb-4">
                    <!-- JS will populate this area with filter items -->
                </div>
                <div class="flex items-center gap-3">
                    <button class="add-filter-btn inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 py-2 bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900">
                        + Add Filter
                    </button>
                    <button class="apply-filters-btn inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 py-2 bg-green-600 text-white hover:bg-green-700 disabled:bg-green-400 dark:disabled:bg-green-800">
                        Apply Filters
                    </button>
                    <button class="reset-filters-btn inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 py-2 bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-500 disabled:bg-slate-100 dark:disabled:bg-slate-700">
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </section>
    {% endfor %}
    
    <!-- Help Card (Initially hidden) -->
    <section class="hidden bg-white dark:bg-slate-800 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 p-6 sm:p-8" id="help-card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">How To Use This App</h2>
            <button id="close-help-btn" class="icon-button h-8 w-8 text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white" title="Close Help">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
            </button>
        </div>
        <div class="prose prose-slate dark:prose-invert max-w-none">
            <p>This application allows you to quickly analyze CSV, TXT, and Excel files. It automatically detects encoding, formats common data types, and provides key statistics about your file.</p>
            <h3>Using Groups</h3>
            <p>You can work with multiple datasets at once. Before uploading, select a Group from the dropdown. The analysis will create a result card below and a new entry in the right sidebar. Hover over an entry to see the delete button. Right-click an entry to rename the group.</p>
            <h3>Data Cleaning Filters</h3>
            <p>After your file is analyzed, you can apply cleaning filters. Click <strong>+ Add Filter</strong> to create a new rule, configure it, and then click <strong>Apply Filters</strong> to see a live preview of the changes. You can stack multiple filters. Click <strong>Reset</strong> to remove all applied filters. The cleaned data will be used when you export.</p>
            <h3>Interface Controls</h3>
            <ul>
                <li><strong>Exporting:</strong> After analyzing a file, use the buttons at the bottom of the results card to download the cleaned data.</li>
                <li><strong>Right Sidebar (Tab Icon):</strong> This panel holds a list of all your active groups. Click an item to scroll directly to its result card.</li>
            </ul>
        </div>
    </section>
</main>

<!-- NEW: Filter Item Template -->
<template id="filter-item-template">
    <div class="filter-item flex items-start gap-3 bg-slate-100 dark:bg-slate-700/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
        <div class="flex-grow space-y-3">
            <select class="filter-type block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="remove_duplicates">Remove Duplicate Rows</option>
                <option value="remove_junk">Remove Rows with Junk Values</option>
            </select>
            <div class="filter-options hidden space-y-3">
                <!-- Content here is specific to the filter type -->
            </div>
        </div>
        <button class="remove-filter-btn h-9 w-9 flex-shrink-0 flex items-center justify-center rounded-md text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400 transition-colors" title="Remove Filter">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
        </button>
    </div>
</template>

{% set server_data = {'groups': groups} %}
<script id="server-data" type="application/json">
  {{ server_data | tojson | safe }}
</script>

{% set msgs = get_flashed_messages(with_categories=true) %}
{% if msgs %}
  <script id="flash‑data" type="application/json">
    {{ msgs|tojson|safe }}
  </script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const htmlEl = document.documentElement;
    let chartInstances = {};
    const toastContainer = document.getElementById('toast-container');
    const mainContainer = document.querySelector('.main-container');

    // --- PARSE SERVER DATA ---
    const serverDataEl = document.getElementById('server-data');
    const serverData = serverDataEl ? JSON.parse(serverDataEl.textContent) : { groups: {} };
    
    const flashEl = document.getElementById("flash‑data");
    const flashedMessages = flashEl ? JSON.parse(flashEl.textContent) : [];

    // --- TOAST NOTIFICATIONS ---
    const showToast = (message, type = 'info') => {
        const icons = {
            success: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            error: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="12"></line><line x1="12" x2="12.01" y1="16" y2="16"></line></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="16" y2="12"></line><line x1="12" x2="12.01" y1="8" y2="8"></line></svg>`,
        };
        const colors = {
            success: 'bg-green-100 dark:bg-green-900/50 border-green-500 dark:border-green-600 text-green-700 dark:text-green-300',
            error: 'bg-red-100 dark:bg-red-900/50 border-red-500 dark:border-red-600 text-red-700 dark:text-red-300',
            info: 'bg-blue-100 dark:bg-blue-900/50 border-blue-500 dark:border-blue-600 text-blue-700 dark:text-blue-300',
        };

        const toast = document.createElement('div');
        toast.className = `w-full flex items-start p-4 rounded-lg shadow-lg border-l-4 transition-all duration-300 transform-gpu ${colors[type] || colors['info']}`;
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'flex-shrink-0';
        iconDiv.innerHTML = icons[type] || icons['info'];
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ml-3 flex-1 pt-0.5 text-sm font-medium';
        messageDiv.textContent = message;

        const closeButton = document.createElement('button');
        closeButton.className = 'ml-4 flex-shrink-0 opacity-70 hover:opacity-100';
        closeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

        toast.appendChild(iconDiv);
        toast.appendChild(messageDiv);
        toast.appendChild(closeButton);
        
        const removeToast = () => {
            toast.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => toast.remove(), 300);
        };

        closeButton.addEventListener('click', removeToast);
        setTimeout(removeToast, 5000);
        
        toastContainer.appendChild(toast);
    };

    // --- THEME ---
    const themeSwitch = document.getElementById('theme-toggle-switch');
    const themeKey = 'themePreference';
    const applySavedTheme = () => {
        const savedTheme = localStorage.getItem(themeKey);
        themeSwitch.checked = savedTheme !== 'light';
        if (themeSwitch.checked) {
            htmlEl.classList.add('dark');
        } else {
            htmlEl.classList.remove('dark');
        }
        initializeAllCharts();
    };
    themeSwitch.addEventListener('change', () => {
        if (themeSwitch.checked) {
            htmlEl.classList.add('dark');
            localStorage.setItem(themeKey, 'dark');
        } else {
            htmlEl.classList.remove('dark');
            localStorage.setItem(themeKey, 'light');
        }
        initializeAllCharts();
    });

    // --- LANGUAGE SELECTOR ---
    const languageSelect = document.getElementById('language-select');
    const languageKey = 'languagePreference';
    const applySavedLanguage = () => {
        const savedLang = localStorage.getItem(languageKey) || 'en';
        if (languageSelect) languageSelect.value = savedLang;
    };
    if (languageSelect) {
        languageSelect.addEventListener('change', () => {
            const selectedLang = languageSelect.value;
            const selectedLangText = languageSelect.options[languageSelect.selectedIndex].text;
            localStorage.setItem(languageKey, selectedLang);
            showToast(`Language set to ${selectedLangText}. UI text update is not yet implemented.`, 'info');
        });
    }

    // --- CHARTS ---
    const getChartColors = () => {
        const isDark = htmlEl.classList.contains('dark');
        return {
            textColor: isDark ? 'rgb(203 213 225)' : 'rgb(71 85 105)',
            gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
            success: '#2dd4bf', highlight: '#3b82f6', danger: '#f43f5e', secondary: '#94a3b8'
        };
    };

    const renderDoughnutChart = (canvasId, data, labels, colors) => {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        const chartColors = getChartColors();
        const chart = new Chart(ctx, {
            type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, spacing: 10, borderRadius: 8, }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: true, position: 'bottom', labels: { color: chartColors.textColor, boxWidth: 12, padding: 20 } }, tooltip: { callbacks: { label: (c) => `${c.label || ''}: ${c.raw.toLocaleString()}` } } } }
        });
        chartInstances[canvasId] = chart;
    };

    const initializeAllCharts = (groupId = null) => {
        const init = (container) => {
            const stats = JSON.parse(container.dataset.stats);
            const gId = container.id.replace('chart-container-', '');
            if (chartInstances[`rows-chart-${gId}`]) chartInstances[`rows-chart-${gId}`].destroy();
            if (chartInstances[`cells-chart-${gId}`]) chartInstances[`cells-chart-${gId}`].destroy();
            const colors = getChartColors();
            if (stats.total_rows > 0) { renderDoughnutChart(`rows-chart-${gId}`, [stats.unique_rows, stats.duplicate_rows], ['Unique', 'Duplicate'], [colors.success, colors.danger]); }
            if (stats.total_cells > 0) { renderDoughnutChart(`cells-chart-${gId}`, [stats.valid_cells, stats.missing_cells], ['Valid', 'Missing'], [colors.highlight, colors.secondary]); }
        };
        if (groupId) {
            const container = document.getElementById(`chart-container-${groupId}`);
            if (container) init(container);
        } else {
            document.querySelectorAll('[id^="chart-container-"]').forEach(init);
        }
    };

    // --- MENUS & HELP ---
    const sideMenu = document.getElementById('side-menu');
    const rightSidebar = document.getElementById('right-sidebar');
    const burgerMenuBtn = document.getElementById('burger-menu');
    const sidebarTabBtn = document.getElementById('sidebar-tab');
    
    const toggleSidebar = (sidebar) => {
        const isOpening = sidebar.classList.contains('-translate-x-full') || sidebar.classList.contains('translate-x-full');
        sideMenu.classList.add('-translate-x-full'); sideMenu.classList.remove('translate-x-0');
        rightSidebar.classList.add('translate-x-full'); rightSidebar.classList.remove('translate-x-0');
        if (isOpening) {
             if (sidebar.id === 'side-menu') { sidebar.classList.remove('-translate-x-full'); sidebar.classList.add('translate-x-0'); } 
             else { sidebar.classList.remove('translate-x-full'); sidebar.classList.add('translate-x-0'); }
        }
    };
    burgerMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(sideMenu); });
    sidebarTabBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(rightSidebar); });
    mainContainer.addEventListener('click', () => {
        sideMenu.classList.add('-translate-x-full'); sideMenu.classList.remove('translate-x-0');
        rightSidebar.classList.add('translate-x-full'); rightSidebar.classList.remove('translate-x-0');
    });
    document.getElementById('help-button').addEventListener('click', () => {
        const helpCard = document.getElementById('help-card');
        helpCard.classList.remove('hidden');
        helpCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
    document.getElementById('close-help-btn')?.addEventListener('click', () => document.getElementById('help-card').classList.add('hidden'));

    // --- FILE UPLOAD UI ---
    const fileInput = document.getElementById('file-upload');
    const fileLabelText = document.getElementById('file-label-text');
    const originalLabelHTML = fileLabelText.innerHTML;
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileLabelText.innerHTML = `<span class="font-semibold text-green-600 dark:text-green-400">✅ ${fileInput.files[0].name}</span>`;
        } else { fileLabelText.innerHTML = originalLabelHTML; }
    });

    // --- FILTERING LOGIC ---
    const filterItemTemplate = document.getElementById('filter-item-template');
    
    const junkOptionsHTML = `
        <div class="space-y-2">
            <div>
                <label class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">Columns to Check</label>
                <input type="text" class="junk-columns w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder='e.g., Name, Email or "ALL"'>
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">Junk Values to Remove</label>
                <input type="text" class="junk-values w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="e.g., N/A, ?, none">
            </div>
        </div>
    `;

    const updateFilterOptions = (selectElement) => {
        const filterItem = selectElement.closest('.filter-item');
        const optionsContainer = filterItem.querySelector('.filter-options');
        const selectedType = selectElement.value;
        optionsContainer.innerHTML = '';
        if (selectedType === 'remove_junk') {
            optionsContainer.innerHTML = junkOptionsHTML;
            optionsContainer.classList.remove('hidden');
        } else {
            optionsContainer.classList.add('hidden');
        }
    };

    const addFilter = (groupId, filterData = null) => {
        const filterList = document.getElementById(`filter-list-${groupId}`);
        const newFilter = filterItemTemplate.content.cloneNode(true);
        const filterItemDiv = newFilter.querySelector('.filter-item');
        const typeSelect = newFilter.querySelector('.filter-type');
        
        filterList.appendChild(newFilter);

        if (filterData) {
            typeSelect.value = filterData.type;
            updateFilterOptions(typeSelect);
            if (filterData.type === 'remove_junk') {
                filterItemDiv.querySelector('.junk-columns').value = Array.isArray(filterData.columns) ? filterData.columns.join(', ') : filterData.columns;
                filterItemDiv.querySelector('.junk-values').value = filterData.values.join(', ');
            }
        }
    };

    const updateCardUI = (groupId, data) => {
        // Update stats grid
        const statsGrid = document.getElementById(`stats-grid-${groupId}`);
        statsGrid.querySelector('[data-stat-key="rows"]').textContent = data.rows.toLocaleString();
        statsGrid.querySelector('[data-stat-key="columns"]').textContent = data.columns.toLocaleString();
        statsGrid.querySelector('[data-stat-key="missing_values"]').textContent = data.missing_values.toLocaleString();
        statsGrid.querySelector('[data-stat-key="duplicate_rows"]').textContent = data.duplicate_rows.toLocaleString();

        // Update charts
        const chartContainer = document.getElementById(`chart-container-${groupId}`);
        chartContainer.dataset.stats = JSON.stringify(data.quality_stats);
        initializeAllCharts(groupId);

        // Update preview table
        const previewContainer = document.getElementById(`preview-container-${groupId}`);
        const table = previewContainer.querySelector('table');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');
        
        thead.innerHTML = data.preview.columns.map(col => `<th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">${col}</th>`).join('');
        tbody.innerHTML = data.preview.data.map(row => `
            <tr class="bg-white dark:bg-slate-900 even:bg-slate-50 dark:even:bg-slate-800/50">
                ${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap align-top text-sm text-slate-700 dark:text-slate-300 font-mono">${cell}</td>`).join('')}
            </tr>
        `).join('');
    };

    const handleFilterAction = async (button, reset = false) => {
        const card = button.closest('[data-group-id]');
        const groupId = card.dataset.groupId;
        const applyBtn = card.querySelector('.apply-filters-btn');
        const resetBtn = card.querySelector('.reset-filters-btn');
        
        // Show loading state
        button.disabled = true;
        const originalText = button.textContent;
        button.innerHTML = `<div class="loader"></div>`;

        let filters = [];
        if (!reset) {
            card.querySelectorAll('.filter-item').forEach(item => {
                const type = item.querySelector('.filter-type').value;
                let filter = { type };
                if (type === 'remove_junk') {
                    const columnsRaw = item.querySelector('.junk-columns').value.trim();
                    const valuesRaw = item.querySelector('.junk-values').value.trim();
                    filter.columns = columnsRaw.toUpperCase() === 'ALL' ? 'ALL' : columnsRaw.split(',').map(v => v.trim()).filter(Boolean);
                    filter.values = valuesRaw.split(',').map(v => v.trim()).filter(Boolean);
                }
                filters.push(filter);
            });
        }
        
        try {
            const response = await fetch(`/apply-filters/${groupId}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filters })
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
                updateCardUI(groupId, data);
                showToast(reset ? 'Filters reset successfully.' : `Filters applied. ${data.rows.toLocaleString()} rows remaining.`, 'success');
                if (reset) {
                    card.querySelector(`#filter-list-${groupId}`).innerHTML = '';
                }
            } else {
                showToast(`Error: ${data.message || 'An unknown error occurred.'}`, 'error');
            }
        } catch (error) {
            showToast('A network error occurred while applying filters.', 'error');
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    };
    
    // --- EVENT LISTENERS (using delegation) ---
    mainContainer.addEventListener('click', e => {
        // Add Filter
        if (e.target.matches('.add-filter-btn')) {
            const card = e.target.closest('[data-group-id]');
            addFilter(card.dataset.groupId);
        }
        // Remove Filter
        if (e.target.closest('.remove-filter-btn')) {
            e.target.closest('.filter-item').remove();
        }
        // Apply Filters
        if (e.target.matches('.apply-filters-btn')) {
            handleFilterAction(e.target);
        }
        // Reset Filters
        if (e.target.matches('.reset-filters-btn')) {
            handleFilterAction(e.target, true);
        }
    });

    mainContainer.addEventListener('change', e => {
        // Toggle filter options based on type
        if (e.target.matches('.filter-type')) {
            updateFilterOptions(e.target);
        }
    });

    // --- OTHER CONTROLS (Sidebar, Rename, Delete) ---
    document.querySelectorAll('.sidebar-item').forEach(tab => {
        tab.addEventListener('click', (e) => {
            if (e.target.closest('.delete-group-btn') || e.target.classList.contains('rename-input')) return;
            const card = document.getElementById(`results-card-${tab.dataset.groupId}`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-4', 'dark:ring-offset-slate-900');
                setTimeout(() => card.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-4', 'dark:ring-offset-slate-900'), 2000);
            }
        });
        
        tab.querySelector('.delete-group-btn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const groupId = tab.dataset.groupId;
            const groupName = tab.querySelector('.sidebar-item-name')?.textContent || 'this group';
            if (!confirm(`Are you sure you want to delete "${groupName}"?`)) return;
            try {
                const response = await fetch('/delete-group', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_id: groupId }) });
                if (response.ok) {
                    tab.remove();
                    document.getElementById(`results-card-${groupId}`)?.remove();
                    showToast(`Group "${groupName}" deleted.`, 'success');
                } else { 
                    const data = await response.json();
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) { showToast('An unexpected network error occurred.', 'error'); }
        });

        tab.addEventListener('contextmenu', e => {
            e.preventDefault();
            const nameSpan = tab.querySelector('.sidebar-item-name');
            const oldDisplayName = nameSpan.textContent;
            const oldGroupId = tab.dataset.groupId;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'w-full bg-transparent border-b-2 border-indigo-500 focus:outline-none rename-input';
            input.value = oldDisplayName;
            nameSpan.parentElement.prepend(input);
            nameSpan.classList.add('hidden');
            input.focus();
            input.select();
            
            const saveRename = async () => {
                const newDisplayName = input.value.trim();
                const cleanup = () => { input.remove(); nameSpan.classList.remove('hidden'); };

                if (!newDisplayName || newDisplayName === oldDisplayName) { cleanup(); return; }

                try {
                    const response = await fetch('/rename-group', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_id: oldGroupId, new_name: newDisplayName }) });
                    const data = await response.json();
                    if (response.ok) {
                        const newGroupId = data.new_id;
                        nameSpan.textContent = data.new_display_name;
                        tab.id = `sidebar-tab-${newGroupId}`;
                        tab.dataset.groupId = newGroupId;
                        tab.querySelector('.delete-group-btn').dataset.groupId = newGroupId;
                        const card = document.getElementById(`results-card-${oldGroupId}`);
                        if (card) {
                             // This is a comprehensive update of all IDs and data attributes
                            card.id = `results-card-${newGroupId}`;
                            card.dataset.groupId = newGroupId;
                            card.querySelectorAll('[id*="' + oldGroupId + '"]').forEach(el => { el.id = el.id.replace(oldGroupId, newGroupId); });
                            card.querySelectorAll('[data-group-id*="' + oldGroupId + '"]').forEach(el => { el.dataset.groupId = newGroupId; });
                            card.querySelector(`#results-title-${newGroupId}`).textContent = `${data.new_display_name}: Analysis & Preview`;
                            card.querySelectorAll('.export-button').forEach(link => { link.href = link.href.replace(`/export/${oldGroupId}/`, `/export/${newGroupId}/`); });
                        }
                        showToast(`Group renamed to "${data.new_display_name}"`, 'success');
                        initializeAllCharts(newGroupId);
                    } else { showToast(`Error: ${data.message}`, 'error'); }
                } catch (error) { showToast('An unexpected error occurred.', 'error'); }
                cleanup();
            };
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { input.remove(); nameSpan.classList.remove('hidden'); } });
        });
    });

    document.querySelectorAll('.export-button').forEach(button => {
        button.addEventListener('click', () => {
            showToast('Your download will begin shortly...', 'info');
        });
    });

    // --- INITIALIZATION ---
    const initializeApp = () => {
        applySavedTheme(); // This also calls initializeAllCharts
        applySavedLanguage();
    
        if (flashedMessages) {
            flashedMessages.forEach(flash => showToast(flash[1], flash[0]));
        }

        // Re-create filters from session on page load
        for (const [groupId, groupData] of Object.entries(serverData.groups)) {
            if (groupData.filters && groupData.filters.length > 0) {
                groupData.filters.forEach(filter => addFilter(groupId, filter));
            }
        }
    };

    initializeApp();
});
</script>
<!-- Download Button (Icon Only) - Placed in header menu -->
<!-- Add this button to the header's menu div, after the other buttons -->
<button id="download-cleaned-btn" class="icon-button h-9 w-9 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors" title="Download Cleaned File" aria-label="Download Cleaned File">
    <a href="/download/cleaned_data.csv" download>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 11l5 5m0 0l5-5m-5 5V4"/>
        </svg>
    </a>
</button>

  <!-- Rest of your content -->

</body>

</html>
