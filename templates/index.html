<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSnap File Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        /* Color Palette Inspired by Reference Images */
        --primary-dark: #0a0f1f;
        --secondary-dark: #10172a;
        --accent-purple: #8A2BE2; /* A vibrant purple */
        --accent-teal: #00D1FF;   /* A bright cyan/teal */
        --accent-blue: #3A82F8;
        --text-primary: #f0f8ff; /* Alice Blue - soft white */
        --text-secondary: #94a3b8; /* Slate 400 */
        --card-bg: rgba(30, 41, 59, 0.6); /* Semi-transparent slate */
        --card-border: rgba(138, 43, 226, 0.2); /* Faint purple border */
        --accent-teal-light: rgba(0, 209, 255, 0.1);

        --color-success: #10b981;
        --color-danger: #ef4444;
        
        /* Typography & Spacing */
        --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --spacing-2: 0.5rem; 
        --spacing-4: 1rem; 
        --spacing-6: 1.5rem; 
        --spacing-8: 2rem; 
        
        /* UI Elements */
        --border-radius-lg: 1rem;
        --border-radius-xl: 1.5rem;
        --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.3);
        --shadow-xl: 0 20px 50px -12px rgba(0,0,0,0.4);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: var(--font-sans);
        background-color: var(--primary-dark);
        color: var(--text-primary);
        min-height: 100vh;
        overflow: hidden;
        position: relative;
        padding: var(--spacing-6);
        line-height: 1.6;
    }

    /* --- Atmospheric Background --- */
    .background-elements {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        pointer-events: none;
        overflow: hidden;
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
    }

    .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(circle, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 2.5rem 2.5rem;
    }

    .glowing-dot {
        position: absolute;
        width: 400px;
        height: 400px;
        border-radius: 50%;
        filter: blur(80px);
        z-index: -1;
        animation: float 15s ease-in-out infinite alternate;
    }

    .dot-1 {
        top: 10%;
        left: 5%;
        background: radial-gradient(circle, rgba(138, 43, 226, 0.15) 0%, transparent 70%);
    }

    .dot-2 {
        bottom: 5%;
        right: 5%;
        background: radial-gradient(circle, rgba(0, 209, 255, 0.15) 0%, transparent 70%);
        animation-delay: -7s;
    }

    /* --- Header --- */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: var(--spacing-4);
        margin-bottom: var(--spacing-8);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .logo-icon {
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .logo-text {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.5px;
        color: var(--text-primary);
    }

    .nav-controls { display: flex; gap: var(--spacing-2); }

    .control-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        backdrop-filter: blur(12px);
    }

    .control-btn:hover {
        background: var(--accent-teal-light);
        color: var(--accent-teal);
        border-color: var(--accent-teal);
        transform: translateY(-2px);
    }

    /* --- Main content wrapper --- */
    .zoom-wrapper {
        transition: transform 0.3s ease-out;
        transform-origin: center center;
    }
    
    /* --- Card Redesign (Glassmorphism) --- */
    .card { 
        background: var(--card-bg); 
        border-radius: var(--border-radius-xl); 
        padding: var(--spacing-8); 
        border: 1px solid var(--card-border); 
        width: 100%; 
        max-width: 520px; 
        position: relative; 
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow-lg);
        transition: var(--transition);
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 30px rgba(138, 43, 226, 0.2);
        border-color: var(--accent-purple);
    }
    
    .card.draggable { 
        position: absolute; 
        z-index: 10; 
        top: 15vh; 
        left: 50%; 
        transform: translateX(-50%); 
        transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; 
    }
    
    .card.draggable.dragging { 
        opacity: 0.9; 
        z-index: 100; 
        box-shadow: var(--shadow-xl);
        transition: none; 
    }
    
    .drag-handle { 
        position: absolute; 
        top: 1rem;
        right: 1rem;
        width: 32px; 
        height: 32px; 
        background: rgba(0,0,0,0.2);
        border-radius: 50%; 
        cursor: grab; 
        transition: var(--transition); 
        z-index: 1; 
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .drag-handle:hover { 
        background: var(--accent-purple);
        color: white;
    }
    
    .dragging .drag-handle { cursor: grabbing; }

    /* --- Card Content & Forms --- */
    .card-header { 
        text-align: center; 
        margin-bottom: var(--spacing-6); 
    }
    
    h1, .results-card h2, .help-card h2 { 
        font-size: 2.25rem; 
        font-weight: 700; 
        letter-spacing: -1px;
        margin: 0 0 var(--spacing-2) 0; 
        background: linear-gradient(90deg, var(--text-primary) 0%, var(--text-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .card-subtitle { 
        font-size: 1rem; 
        color: var(--text-secondary); 
        margin: 0 auto; 
        max-width: 45ch;
    }

    .upload-form { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: var(--spacing-6); 
    }
    
    .file-drop-area { 
        width: 100%; 
        border: 2px dashed var(--card-border); 
        border-radius: var(--border-radius-lg); 
        padding: var(--spacing-6); 
        cursor: pointer; 
        transition: var(--transition); 
        color: var(--text-secondary); 
        text-align: center; 
        background: rgba(15, 23, 42, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-2);
        min-height: 140px;
    }
    
    .file-drop-area:hover, .file-drop-area.drag-over { 
        border-color: var(--accent-teal); 
        color: var(--accent-teal); 
        background: var(--accent-teal-light);
    }
    
    .file-drop-icon { font-size: 2.5rem; color: var(--accent-purple); }
    
    .upload-form input[type="file"] { display: none; }
    
    .form-group { width: 100%; }
    
    .form-group label { 
        font-weight: 500; 
        color: var(--text-secondary); 
        font-size: 0.875rem; 
        margin-bottom: var(--spacing-2); 
        display: block; 
    }
    
    .form-group select { 
        width: 100%; 
        padding: 0.8rem 1rem;
        background-color: var(--secondary-dark); 
        border: 1px solid var(--card-border); 
        border-radius: 0.5rem; 
        color: var(--text-primary); 
        font-family: var(--font-sans); 
        font-size: 1rem; 
        cursor: pointer; 
        transition: var(--transition);
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1rem;
    }
    
    .form-group select:focus {
        border-color: var(--accent-teal);
        box-shadow: 0 0 0 3px var(--accent-teal-light);
        outline: none;
    }

    .primary-button { 
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
        color: white; 
        border: none; 
        width: 100px; 
        height: 100px; 
        font-size: 1rem; 
        font-weight: 600; 
        border-radius: 50%;
        cursor: pointer; 
        transition: var(--transition); 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        box-shadow: 0 8px 20px -5px rgba(138, 43, 226, 0.4);
    }
    
    .primary-button:hover { 
        transform: scale(1.05) translateY(-2px); 
        box-shadow: 0 12px 25px -5px rgba(0, 209, 255, 0.3); 
    }

    /* --- Sidebars --- */
    #right-sidebar { 
        position: fixed; 
        top: 0; 
        right: 0; 
        height: 100vh; 
        width: 320px; 
        background-color: var(--card-bg); 
        box-shadow: var(--shadow-xl); 
        border-left: 1px solid var(--card-border); 
        transform: translateX(100%); 
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        z-index: 1000; 
        padding: 80px var(--spacing-4) var(--spacing-4); 
        color: var(--text-primary); 
        overflow-y: auto; 
        backdrop-filter: blur(12px);
    }
    
    #right-sidebar.open { transform: translateX(0); }

    .sidebar-item { 
        position: relative; 
        background-color: transparent;
        padding: var(--spacing-4); 
        border: 1px solid transparent; 
        border-radius: var(--border-radius-lg); 
        cursor: grab; 
        margin-bottom: var(--spacing-2); 
        font-weight: 600; 
        font-size: 1rem; 
        transition: var(--transition); 
    }
    
    .sidebar-item:hover { 
        background-color: var(--accent-teal-light);
        border-color: var(--accent-teal);
    }
    
    .sidebar-item small { 
        font-weight: 400; 
        font-size: 0.8rem; 
        color: var(--text-secondary); 
        display: block; 
        margin-top: 4px; 
        overflow-wrap: anywhere;
    }
    
    /* --- Results & Stats --- */
    .results-card {
        max-width: 900px;
    }
    .results-card h2 { font-size: 1.75rem; text-align: center; }
    
    .results-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
        gap: var(--spacing-4); 
        margin: var(--spacing-6) 0;
    }
    
    .stat-card { 
        background-color: rgba(15, 23, 42, 0.5);
        border: 1px solid var(--card-border); 
        padding: var(--spacing-4); 
        border-radius: var(--border-radius-lg); 
        transition: var(--transition);
    }
    
    .stat-card-label { 
        font-size: 0.8rem; 
        color: var(--text-secondary); 
        margin-bottom: var(--spacing-2); 
        display: block; 
    }
    
    .stat-card-value { 
        font-size: 1.25rem; 
        font-weight: 600; 
        color: var(--text-primary); 
        overflow-wrap: anywhere;
    }
    
    .table-wrapper { 
        overflow-x: auto; 
        border: 1px solid var(--card-border);
        border-radius: var(--border-radius-lg);
        background-color: rgba(15, 23, 42, 0.5);
    }
    
    .data-table { 
        width: 100%; 
        border-collapse: collapse; 
        white-space: nowrap; 
    }
    
    .data-table th, .data-table td { 
        padding: 0.8rem 1rem;
        text-align: left; 
        border-bottom: 1px solid var(--card-border); 
        font-size: 0.9rem; 
    }
    
    .data-table th {
        font-weight: 600;
        color: var(--text-secondary);
    }
    .data-table tr:last-child td { border-bottom: none; }
    
    /* --- Universal UI States --- */
    .is-fading-out { opacity: 0; transform: scale(0.9); pointer-events: none; }
    .is-hidden { display: none !important; }
    
    /* Floating animation for primary card */
    @keyframes float {
        0% { transform: translate(0px, 0px); }
        50% { transform: translate(10px, -15px); }
        100% { transform: translate(0px, 0px); }
    }
    
    .floating { animation: float 8s ease-in-out infinite; }
    
    /* --- Responsive adjustments --- */
    @media (max-width: 768px) {
        body { padding: var(--spacing-4); }
        .header { flex-direction: column; gap: var(--spacing-4); }
        .card { padding: var(--spacing-6); }
        #right-sidebar { width: 280px; }
        .results-card { max-width: 100%; }
        .zoom-wrapper { padding: 0; }
    }
    
    /* --- Utility classes and minor elements not refactored yet --- */
    /* This section contains styles from your original file that are needed for functionality but not fully redesigned. */
    /* You can incrementally update these to match the new aesthetic. */
    #side-menu { display: none; } /* Hide old side menu, can be redesigned later */
    .top-right-controls { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1001; }
    #sidebar-tab { display: none; } /* Replaced by burger menu */
    .rename-input { width: 100%; padding: 0; margin: 0; background: transparent; border: none; border-bottom: 2px solid var(--accent-teal); color: var(--text-primary); font-family: var(--font-sans); font-size: 1rem; font-weight: 700; outline: none; }
    .delete-group-btn { position: absolute; top: 6px; right: 6px; width: 24px; height: 24px; background: transparent; border: none; cursor: pointer; color: var(--text-secondary); opacity: 0; pointer-events: none; transition: var(--transition); padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .sidebar-item:hover .delete-group-btn { opacity: 0.6; pointer-events: auto; }
    .delete-group-btn:hover { opacity: 1; color: var(--color-danger); background-color: rgba(239, 68, 68, 0.1); }
    .dock-btn, #close-help-btn { position: absolute; top: 1rem; left: 1rem; width: 32px; height: 32px; background: rgba(0,0,0,0.2); border: none; cursor: pointer; color: var(--text-secondary); transition: var(--transition); padding: 0; border-radius: 50%; }
    .dock-btn:hover, #close-help-btn:hover { color: var(--accent-teal); background-color: var(--accent-teal-light); }
    .pan-controls, .zoom-controls { display:none; } /* Hide old pan/zoom, can be reintegrated */
    #onboarding-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; backdrop-filter: blur(4px); }
    .onboarding-highlight { position: relative; z-index: 2001; box-shadow: 0 0 0 4px var(--accent-teal), 0 0 20px 5px var(--accent-teal); border-radius: 1rem; transition: var(--transition); }
    #onboarding-tooltip { position: absolute; z-index: 2002; background-color: var(--card-bg); color: var(--text-primary); padding: var(--spacing-4); border-radius: var(--border-radius-lg); border: 1px solid var(--card-border); box-shadow: var(--shadow-lg); width: 280px; backdrop-filter: blur(10px); }
    #onboarding-tooltip p { margin: 0 0 var(--spacing-4) 0; color: var(--text-secondary); }
    .onboarding-buttons { display: flex; justify-content: space-between; align-items: center; }
    .onboarding-buttons button { background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%); color: white; border: none; padding: var(--spacing-2) var(--spacing-4); border-radius: 0.5rem; cursor: pointer; transition: var(--transition); }
    .onboarding-buttons button.skip { background: transparent; border: 1px solid var(--card-border); }
    
    </style>
</head>
<body>
    <div class="background-elements">
        <div class="grid-overlay"></div>
        <div class="glowing-dot dot-1"></div>
        <div class="glowing-dot dot-2"></div>
    </div>

    <header class="header">
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-wave-square"></i></div>
            <div class="logo-text">DataSnap</div>
        </div>
        <div class="nav-controls">
            <div class="control-btn" id="burger-menu" title="Open Groups" aria-label="Open Groups">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="control-btn" id="help-button" title="Help" aria-label="Open help guide">
                <i class="fas fa-question"></i>
            </div>
        </div>
    </header>

    <aside id="right-sidebar">
        <!-- Sidebar content will be dynamically generated -->
        {% for group_id, results in groups.items() %}
        <div class="sidebar-item" id="sidebar-tab-{{ group_id }}" data-group-id="{{ group_id }}" title="Drag to Undock. Right-click to rename." role="button" tabindex="0">
            <span class="sidebar-item-name">{{ results.display_name }}</span>
            <small class="sidebar-item-filename">{{ results.filename }}</small>
            <button class="delete-group-btn" data-group-id="{{ group_id }}" title="Delete Group">
                <i class="fas fa-times"></i>
            </button>
        </div>
        {% endfor %}
    </aside>

    <div class="zoom-wrapper" id="zoom-wrapper">
        <main class="main-container">
            <section class="card draggable floating" id="upload-card">
                <div class="drag-handle" title="Drag"><i class="fas fa-arrows-alt"></i></div>
                <div class="card-header">
                    <h1>Next Gen Analysis</h1>
                    <p class="card-subtitle">Instantly examine structure, metadata, and content from your data files.</p>
                </div>
                <form method="post" enctype="multipart/form-data" class="upload-form">
                    <label for="file-upload" class="file-drop-area" id="file-label">
                        <i class="fas fa-cloud-upload-alt file-drop-icon"></i>
                        <span id="file-label-text">Click or drag & drop file</span>
                    </label>
                    <input id="file-upload" type="file" name="file" required>
                    
                    <div class="form-group">
                        <label for="group-select">Assign to Group</label>
                        <select name="group_id" id="group-select" required>
                            <option value="group_1">Group 1</option>
                            <option value="group_2">Group 2</option>
                            <option value="group_3">Group 3</option>
                            <option value="group_4">Group 4</option>
                            <option value="group_5">Group 5</option>
                        </select>
                    </div>

                    <button type="submit" class="primary-button">Analyze</button>
                </form>
            </section>

            {% if error %}
                <section class="card draggable error" id="error-card">
                    <div class="drag-handle" title="Drag"><i class="fas fa-arrows-alt"></i></div>
                    {{ error }}
                </section>
            {% endif %}

            {% for group_id, results in groups.items() %}
            <section class="card draggable results-card is-hidden" id="results-card-{{ group_id }}" data-group-id="{{ group_id }}">
                <button class="dock-btn" id="dock-btn-{{ group_id }}" title="Dock to sidebar"><i class="fas fa-thumbtack"></i></button>
                <div class="drag-handle" title="Drag"><i class="fas fa-arrows-alt"></i></div>
                <h2 id="results-title-{{ group_id }}">{{ results.display_name }}: Analysis</h2>
                <div class="results-grid">
                    <div class="stat-card"><span class="stat-card-label">File Name</span><span class="stat-card-value">{{ results.filename }}</span></div>
                    <div class="stat-card"><span class="stat-card-label">File Size</span><span class="stat-card-value">{{ results.filesize_kb }} KB</span></div>
                    <div class="stat-card"><span class="stat-card-label">Rows</span><span class="stat-card-value">{{ results.rows }}</span></div>
                    <div class="stat-card"><span class="stat-card-label">Columns</span><span class="stat-card-value">{{ results.columns }}</span></div>
                    <div class="stat-card"><span class="stat-card-label">Missing Cells</span><span class="stat-card-value">{{ results.missing_values }}</span></div>
                    <div class="stat-card"><span class="stat-card-label">Duplicate Rows</span><span class="stat-card-value">{{ results.duplicate_rows }}</span></div>
                </div>
                <div class="table-wrapper">
                    {{ results.preview|safe }}
                </div>
            </section>
            {% endfor %}
            
            <section class="card draggable help-card is-hidden" id="help-card">
                <button id="close-help-btn" title="Close Help"><i class="fas fa-times"></i></button>
                <div class="drag-handle" title="Drag"><i class="fas fa-arrows-alt"></i></div>
                <h2>Help Guide</h2>
                <p>Welcome to DataSnap! Here's how to navigate your new workspace:</p>
                <h3>Groups & Cards</h3>
                <ul>
                    <li>Use the <i class="fas fa-layer-group"></i> icon to open the Groups sidebar.</li>
                    <li>Drag a group from the sidebar to create a movable analysis card.</li>
                    <li>Dock a card back to the sidebar using the <i class="fas fa-thumbtack"></i> icon.</li>
                    <li>Right-click a group in the sidebar to rename it.</li>
                </ul>
                <h3>Navigation</h3>
                <p>Freely drag cards around the workspace. More navigation features like pan and zoom can be re-integrated based on this new design.</p>
            </section>
        </main>
    </div>
    
    <div id="onboarding-overlay" class="is-hidden"></div>
    <div id="onboarding-tooltip" class="is-hidden">
        <p id="onboarding-text"></p>
        <div class="onboarding-buttons">
            <button id="onboarding-skip-btn" class="skip">Skip</button>
            <button id="onboarding-next-btn">Next</button>
        </div>
    </div>
    
    <script>
    // This script keeps your original functionality but is adapted for the new class names and elements.
    document.addEventListener('DOMContentLoaded', function() {
        // --- Burger menu now controls the right sidebar ---
        document.getElementById('burger-menu').addEventListener('click', () => {
            document.getElementById('right-sidebar').classList.toggle('open');
        });

        // Dragover effect for file drop area
        const fileDropArea = document.getElementById('file-label');
        if (fileDropArea) {
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropArea.classList.add('drag-over');
            });
            fileDropArea.addEventListener('dragleave', () => {
                fileDropArea.classList.remove('drag-over');
            });
            fileDropArea.addEventListener('drop', () => {
                fileDropArea.classList.remove('drag-over');
            });
        }
        
        // The rest of your original, functional JavaScript remains here.
        // It has been checked for compatibility with the new class names.
        const body = document.body;

        const fileInput = document.getElementById('file-upload');
        if (fileInput) { 
            const fileLabelText = document.getElementById('file-label-text'); 
            const originalLabelText = fileLabelText.innerHTML; 
            fileInput.addEventListener('change', () => { 
                fileLabelText.innerHTML = fileInput.files.length > 0 ? 
                    `<span style="color: var(--color-success); font-weight: 600;"><i class="fas fa-check-circle"></i> ${fileInput.files[0].name}</span>` : 
                    originalLabelText; 
            });
        }
        
        document.getElementById('help-button').addEventListener('click', () => 
            document.getElementById('help-card').classList.toggle('is-hidden')
        );
        
        document.getElementById('close-help-btn').addEventListener('click', () => 
            document.getElementById('help-card').classList.add('is-hidden')
        );

        const groupStatesKey = 'groupCardStates';
        
        function getGroupStates() { try { return JSON.parse(localStorage.getItem(groupStatesKey)) || {}; } catch { return {}; } }
        function setGroupState(groupId, state) { const states = getGroupStates(); states[groupId] = state; localStorage.setItem(groupStatesKey, JSON.stringify(states)); }
        function removeGroupState(groupId) { const states = getGroupStates(); delete states[groupId]; localStorage.setItem(groupStatesKey, JSON.stringify(states)); }
        function renameGroupState(oldId, newId) { const states = getGroupStates(); if (states[oldId]) { states[newId] = states[oldId]; delete states[oldId]; localStorage.setItem(groupStatesKey, JSON.stringify(states)); } }

        function initializeGroupStates() {
            const states = getGroupStates();
            document.querySelectorAll('.results-card').forEach(card => {
                const groupId = card.dataset.groupId;
                const tab = document.getElementById(`sidebar-tab-${groupId}`);
                if (!tab) return;
                const state = states[groupId] || 'docked';
                if (state === 'undocked') { card.classList.remove('is-hidden'); tab.classList.add('is-hidden'); } 
                else { card.classList.add('is-hidden'); tab.classList.remove('is-hidden'); }
            });
        }

        function setupDeleteControls(button) {
            button.addEventListener('click', async (e) => {
                e.stopPropagation();
                const groupId = button.dataset.groupId;
                if (!confirm(`Are you sure you want to delete this group?`)) return;
                try {
                    const response = await fetch('/delete-group', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_id: groupId }) });
                    if (response.ok) {
                        document.getElementById(`sidebar-tab-${groupId}`)?.remove();
                        document.getElementById(`results-card-${groupId}`)?.remove();
                        removeGroupState(groupId);
                        localStorage.removeItem(`card-pos-results-card-${groupId}`);
                    } else { const data = await response.json(); alert(`Error: ${data.message || 'Could not delete.'}`); }
                } catch (error) { alert('A network error occurred.'); }
            });
        }

        function setupRenameControls(tab) {
            tab.addEventListener('contextmenu', e => {
                e.preventDefault();
                const nameSpan = tab.querySelector('.sidebar-item-name');
                const oldDisplayName = nameSpan.textContent;
                const oldGroupId = tab.dataset.groupId;
                
                const input = document.createElement('input');
                input.type = 'text'; input.className = 'rename-input'; input.value = oldDisplayName;
                nameSpan.style.display = 'none';
                tab.querySelector('.sidebar-item-filename').style.display = 'none';
                tab.prepend(input); input.focus(); input.select();

                const saveRename = async () => {
                    const newDisplayName = input.value.trim();
                    const cleanup = (displayName) => { nameSpan.textContent = displayName; input.remove(); nameSpan.style.display = ''; tab.querySelector('.sidebar-item-filename').style.display = ''; };
                    
                    if (!newDisplayName || newDisplayName === oldDisplayName) { cleanup(oldDisplayName); return; }

                    try {
                        const response = await fetch('/rename-group', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_id: oldGroupId, new_name: newDisplayName }) });
                        const data = await response.json();
                        if (response.ok) {
                            const newGroupId = data.new_id;
                            tab.id = `sidebar-tab-${newGroupId}`; tab.dataset.groupId = newGroupId;
                            tab.querySelector('.delete-group-btn').dataset.groupId = newGroupId;
                            
                            const card = document.getElementById(`results-card-${oldGroupId}`);
                            if(card) {
                                card.id = `results-card-${newGroupId}`; card.dataset.groupId = newGroupId;
                                const title = document.getElementById(`results-title-${oldGroupId}`);
                                title.id = `results-title-${newGroupId}`; title.textContent = `${data.new_display_name}: Analysis`;
                                document.getElementById(`dock-btn-${oldGroupId}`).id = `dock-btn-${newGroupId}`;
                            }
                            
                            renameGroupState(oldGroupId, newGroupId);
                            const pos = localStorage.getItem(`card-pos-results-card-${oldGroupId}`);
                            if (pos) { localStorage.setItem(`card-pos-results-card-${newGroupId}`, pos); localStorage.removeItem(`card-pos-results-card-${oldGroupId}`); }
                            
                            cleanup(data.new_display_name);
                        } else { alert(`Error: ${data.message}`); cleanup(oldDisplayName); }
                    } catch (error) { alert('An error occurred.'); cleanup(oldDisplayName); }
                };
                
                input.addEventListener('blur', saveRename);
                input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { input.remove(); nameSpan.style.display = ''; tab.querySelector('.sidebar-item-filename').style.display = ''; } });
            });
        }

        function setupGroupControls(card) {
            const getGroupId = () => card.dataset.groupId;
            const dockBtn = document.getElementById(`dock-btn-${getGroupId()}`);
            if (!dockBtn) return;
            
            dockBtn.addEventListener('click', () => { 
                card.classList.add('is-fading-out'); 
                setGroupState(getGroupId(), 'docked'); 
                setTimeout(() => { 
                    card.classList.add('is-hidden'); 
                    card.classList.remove('is-fading-out'); 
                    document.getElementById(`sidebar-tab-${getGroupId()}`).classList.remove('is-hidden', 'is-fading-out'); 
                }, 300); 
            });
        }
        
        function setupTabControls(tab) {
            const undockAction = (e) => {
                const currentGroupId = tab.dataset.groupId;
                const currentCard = document.getElementById(`results-card-${currentGroupId}`);
                if (!currentCard) return;
                
                tab.classList.add('is-fading-out');
                setGroupState(currentGroupId, 'undocked');
                
                setTimeout(() => tab.classList.add('is-hidden'), 300);
                
                currentCard.classList.remove('is-hidden', 'is-fading-out');
                currentCard.style.left = `${e.clientX - (currentCard.offsetWidth / 2)}px`;
                currentCard.style.top = `${e.clientY - 20}px`;
                currentCard.style.transform = 'none';
                
                currentCard.querySelector('.drag-handle').dispatchEvent(new MouseEvent('mousedown', { bubbles: true, cancelable: true, clientX: e.clientX, clientY: e.clientY }));
            };
            
            tab.addEventListener('mousedown', (e) => { 
                if (e.button === 0 && !e.target.closest('.delete-group-btn') && !e.target.closest('.rename-input')) 
                    undockAction(e); 
            });
        }
        
        function makeDraggable(element) {
            const dragHandle = element.querySelector('.drag-handle');
            if (!dragHandle) return;
            let isDragging = false, startX, startY, startLeft, startTop;
            const getStorageKey = () => element.id ? `card-pos-${element.id}` : null;
            dragHandle.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; isDragging = true;
                element.style.left = `${element.offsetLeft}px`; element.style.top = `${element.offsetTop}px`; element.style.transform = 'none';
                startLeft = element.offsetLeft; startTop = element.offsetTop; startX = e.pageX; startY = e.pageY;
                element.classList.add('dragging'); document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return; e.preventDefault();
                const deltaX = e.pageX - startX; const deltaY = e.pageY - startY;
                element.style.left = `${startLeft + deltaX}px`; element.style.top = `${startTop + deltaY}px`;
            });
            document.addEventListener('mouseup', () => {
                if (!isDragging) return; isDragging = false;
                element.classList.remove('dragging'); document.body.style.userSelect = '';
                const key = getStorageKey();
                if (key) { localStorage.setItem(key, JSON.stringify({ top: element.style.top, left: element.style.left })); }
            });
        }
        
        function applySavedPositions() { 
            document.querySelectorAll('.draggable').forEach(el => { 
                if (!el.id) return; 
                const savedPos = localStorage.getItem(`card-pos-${el.id}`); 
                if (savedPos) { 
                    try { 
                        const { top, left } = JSON.parse(savedPos); 
                        if (top && left) { el.style.top = top; el.style.left = left; el.style.transform = 'none'; } 
                    } catch (e) { console.error("Could not parse position", e); } 
                } 
            }); 
        }

        function handleOnboarding() {
            if (localStorage.getItem('onboardingComplete') === 'true') return;
            const overlay = document.getElementById('onboarding-overlay');
            const tooltip = document.getElementById('onboarding-tooltip');
            if(!overlay || !tooltip) return;
            const tooltipText = document.getElementById('onboarding-text');
            const nextBtn = document.getElementById('onboarding-next-btn');
            const skipBtn = document.getElementById('onboarding-skip-btn');
            let currentStepIndex = 0, highlightedElement = null;
            const steps = [ 
                { element: '#upload-card .drag-handle', text: 'Welcome! Drag this handle to move cards around your workspace.' }, 
                { element: '#burger-menu', text: 'Click here to open the Groups sidebar where all your analyses are stored.' },
                { element: '.sidebar-item', text: 'You can drag groups out from the sidebar to view them. Right-click to rename.' }
            ];
            
            function showStep(index) { 
                if (highlightedElement) highlightedElement.classList.remove('onboarding-highlight');
                const step = steps[index]; 
                const target = document.querySelector(step.element); 
                if (!target) { nextStep(); return; } 
                highlightedElement = target; highlightedElement.classList.add('onboarding-highlight');
                tooltipText.textContent = step.text; 
                const targetRect = target.getBoundingClientRect(); 
                tooltip.style.top = `${targetRect.bottom + 15}px`; 
                tooltip.style.left = `${targetRect.left + (targetRect.width / 2) - (tooltip.offsetWidth / 2)}px`; 
                if(parseInt(tooltip.style.left) < 10) tooltip.style.left = '10px';
                if((parseInt(tooltip.style.left) + tooltip.offsetWidth) > window.innerWidth - 10) tooltip.style.left = `${window.innerWidth - tooltip.offsetWidth - 10}px`;
                nextBtn.textContent = (index === steps.length - 1) ? 'Finish' : 'Next'; 
            }
            function nextStep() { currentStepIndex++; currentStepIndex < steps.length ? showStep(currentStepIndex) : endOnboarding(); }
            function endOnboarding() { 
                overlay.classList.add('is-hidden'); tooltip.classList.add('is-hidden'); 
                if (highlightedElement) highlightedElement.classList.remove('onboarding-highlight'); 
                localStorage.setItem('onboardingComplete', 'true'); 
            }
            
            overlay.classList.remove('is-hidden'); tooltip.classList.remove('is-hidden'); 
            nextBtn.addEventListener('click', nextStep); skipBtn.addEventListener('click', endOnboarding); 
            showStep(0);
        }

        // --- INITIALIZATION ---
        applySavedPositions();
        document.querySelectorAll('.draggable').forEach(makeDraggable);
        document.querySelectorAll('.results-card').forEach(setupGroupControls);
        document.querySelectorAll('.sidebar-item').forEach(tab => {
            setupTabControls(tab);
            setupRenameControls(tab);
            const deleteBtn = tab.querySelector('.delete-group-btn');
            if (deleteBtn) setupDeleteControls(deleteBtn);
        });
        initializeGroupStates();
        setTimeout(handleOnboarding, 500); // Delay onboarding slightly
    });
    </script>
</body>
</html>